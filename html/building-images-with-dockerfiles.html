<p><img src="https://s3.amazonaws.com/learningdocker/wordpress/building-images-with-dockerfiles/making-containers.jpg" alt="image" /></p>

<p>As part of going through the steps outlined under <em><a href="http://learningdocker.com/running-rails-app-over-two-docker-containers-legacy/">Running a Rails App over Two Docker Containers</a></em>, we pulled the <code>learningdocker/docker_quick_start</code> image from Docker Hub onto the Boot2Docker virtual machine.  Instead of using an already made image, we will now build the Rails application's Docker image on the Boot2Docker virtual machine via our Mac OS X host and push the final image onto our Docker Hub accounts.</p>

<!--more-->

<ol>
<li><p>Please create an account on <a href="https://hub.docker.com">Docker Hub</a>.</p>

<p><img src="https://s3.amazonaws.com/learningdocker/wordpress/building-images-with-dockerfiles/docker-hub-sign-up.png" alt="image" /></p></li>
<li><p>Log into your Docker Hub account from the command-line console.</p>

<pre><code>Host% docker login
Username: &lt;Your Docker Hub Username&gt;
Password: &lt;Your Docker Hub Password&gt;
Email: &lt;Your Email Address&gt;
Login Succeeded

Host% export DOCKERUSER=&lt;Your Docker Hub Username&gt;
</code></pre></li>
<li><p>Delete the <code>learningdocker/docker_quick_start</code> image.</p>

<pre><code>Host% docker images
REPOSITORY                         TAG     IMAGE ID      VIRTUAL SIZE
learningdocker/docker_quick_start  latest  223ac352ac09  781 MB
jpetazzo/nsenter                   latest  1084fe82d2fe  323.4 MB
kamui/postgresql                   latest  249dad1e2537  387.5 MB

Host% docker rmi learningdocker/docker_quick_start

Host% docker images
REPOSITORY                         TAG     IMAGE ID      VIRTUAL SIZE
jpetazzo/nsenter                   latest  1084fe82d2fe  323.4 MB
kamui/postgresql                   latest  249dad1e2537  387.5 MB
</code></pre></li>
<li><p>Download the <a href="https://github.com/LearningDocker/docker_quick_start">dockerized Ruby on Rails Tutorial sample application</a>.  This sample application is forked from the one developed and maintained by Michael Hartl for his self-paced learning program <a href="http://www.railstutorial.org/">Ruby on Rails Tutorial: Learn Web Development with Rails</a>.</p>

<pre><code>Host% git clone http://github.com/LearningDocker/docker_quick_start.git
</code></pre></li>
<li><p>Run <code>docker build</code> on the Dockerfile.  On this particular build, the process took almost 18 minutes to complete.  While waiting for the image build to finish, please check out <em><a href="http://LearningDocker.com/dockerfile-walkthrough-legacy/">Dockerfile Walkthrough</a></em> to see how each Dockerfile instruction works to generate one layer in the final image.</p>

<pre><code>Host% time docker build -t $DOCKERUSER/docker_quick_start .
Sending build context to Docker daemon   6.3 MB
Sending build context to Docker daemon 
Step 0 : FROM debian:jessie
 ---&gt; 431dac4e3917
Step 1 : MAINTAINER Learning Docker &lt;jimmy.huang@learningdocker.com&gt;
 ---&gt; Running in 8bedc332ec3e
 ---&gt; bf6e66ab7ba8
Removing intermediate container 8bedc332ec3e
Step 2 : RUN apt-get update &amp;&amp; apt-get install -qy \
         curl  git  libpq-dev  libprocps3  libprocps3-dev \
         nodejs  postgresql  procps
 ---&gt; Running in 79a5bd4eadb3
 ---&gt; 414985d91f17
Removing intermediate container 79a5bd4eadb3
Step 3 : RUN curl -sSL https://get.rvm.io | bash -s stable
 ---&gt; Running in 26c4f921b49b
Downloading https://github.com/wayneeseguin/rvm/archive/stable.tar.gz
Creating group 'rvm'
Installing RVM to /usr/local/rvm/
 ---&gt; f6c04b16f9a3
Removing intermediate container 26c4f921b49b
Step 4 : RUN ["/bin/bash", "-l", "-c", 
              "rvm requirements; 
              rvm install 2.1.2; 
              gem install bundler --no-ri --no-rdoc"]
 ---&gt; Running in ede144850d97
Checking requirements for debian.
Installing requirements for debian.
Updating system..
Installing required packages: bzip2, gawk, g++, make, libreadline6-dev, 
                              libyaml-dev, libsqlite3-dev, sqlite3, 
                              autoconf, libgdbm-dev, libncurses5-dev,  
                              automake, libtool, bison, pkg-config, 
                              libffi-dev...................
Requirements installation successful.
Searching for binary rubies, this might take some time.
Found remote file 
https://rvm.io/binaries/debian/jessie_sid/x86_64/ruby-2.1.2.tar.bz2
Checking requirements for debian.
Requirements installation successful.
ruby-2.1.2 - #configure
ruby-2.1.2 - #download
ruby-2.1.2 - #validate archive
ruby-2.1.2 - #extract
ruby-2.1.2 - #validate binary
ruby-2.1.2 - #setup
ruby-2.1.2 - #gemset created /usr/local/rvm/gems/ruby-2.1.2@global
ruby-2.1.2 - #importing gemset /usr/local/rvm/gemsets/global.gems
ruby-2.1.2 - #generating global wrappers........
ruby-2.1.2 - #gemset created /usr/local/rvm/gems/ruby-2.1.2
ruby-2.1.2 - #importing gemsetfile /usr/local/rvm/gemsets/default.gems 
             evaluated to empty gem list
ruby-2.1.2 - #generating default wrappers........
Successfully installed bundler-1.7.2
1 gem installed
 ---&gt; 20530f4640b2
Removing intermediate container ede144850d97
Step 5 : COPY Gemfile /app/Gemfile
 ---&gt; b4a579d1f1f3
Removing intermediate container b99cac9a1867
Step 6 : COPY Gemfile.lock /app/Gemfile.lock
 ---&gt; 0ee1481ca560
Removing intermediate container d92be5f63e65
Step 7 : WORKDIR /app
 ---&gt; Running in 37c0323f847b
 ---&gt; 2d37b923faf9
Removing intermediate container 37c0323f847b
Step 8 : RUN ["/bin/bash", "-l", "-c", "bundle install"]
 ---&gt; Running in a5744cc0142e
Installing gems specified in the Gemfile
Your bundle is complete!

&lt;= 1.8.6 : unsupported
 = 1.8.7 : gem install rdoc-data; rdoc-data --install
 = 1.9.1 : gem install rdoc-data; rdoc-data --install
&gt;= 1.9.2 : nothing to do! Yay!
 ---&gt; 1c18d721dd22
Removing intermediate container a5744cc0142e
Step 9 : ADD . /app
 ---&gt; 84224a27c2f0
Removing intermediate container 0515622b4ed8
Step 10 : EXPOSE 3000
 ---&gt; Running in 146029e01521
 ---&gt; be55e982050d
Removing intermediate container 146029e01521
Step 11 : CMD ["/app/bin/start-server"]
 ---&gt; Running in 1c9b26a605da
 ---&gt; 25eaf04c070f
Removing intermediate container 1c9b26a605da
Successfully built 25eaf04c070f

real    7m24.547s
user    0m0.055s
sys 0m0.051s
</code></pre></li>
<li><p>See what images got built.</p>

<pre><code>Host% docker images
REPOSITORY                      TAG     IMAGE ID      VIRTUAL SIZE
$DOCKERUSER/docker_quick_start  latest  25eaf04c070f  796.7 MB
debian                          jessie  431dac4e3917  90.08 MB
jpetazzo/nsenter                latest  1084fe82d2fe  323.4 MB
kamui/postgresql                latest  249dad1e2537  387.5 MB
</code></pre></li>
<li><p>Call <code>docker history</code> on <code>$DOCKERUSER/docker_quick_start</code> to see how Docker built this image step by step in reverse chronological order.</p>

<pre><code>Host$ docker history $DOCKERUSER/docker_quick_start
IMAGE         CREATED BY                                        SIZE
25eaf04c070f  /bin/sh -c #(nop) CMD [/app/bin/start-server]     0 B
be55e982050d  /bin/sh -c #(nop) EXPOSE map[3000/tcp:{}]         0 B
84224a27c2f0  /bin/sh -c #(nop) ADD dir:b90cb58b63462c3c0a0
              in /app                                           6.029 MB
1c18d721dd22  /bin/sh -c /bin/bash -l -c "bundle install"       155.8 MB
2d37b923faf9  /bin/sh -c #(nop) WORKDIR /app                    0 B
0ee1481ca560  /bin/sh -c #(nop) COPY file:3a3f329c666dbce04
              /app/Gemfile.lock                                 6.054 kB
b4a579d1f1f3  /bin/sh -c #(nop) COPY file:afdf4c2baf9660cfc  
              in /app/Gemfile                                   1.287 kB
20530f4640b2  /bin/bash -l -c rvm requirements; 
              rvm install 2.1.2; gem install bundler --no-ri 
              --no-rdoc                                         263 MB
f6c04b16f9a3  /bin/sh -c curl -sSL https://get.rvm.io | 
              bash -s stable                                    7.732 MB
414985d91f17  /bin/sh -c apt-get update &amp;&amp; apt-get install 
              -qy curl git libpq-dev libprocps3 libprocps3-dev 
              nodejs postgresql procps                          274 MB
bf6e66ab7ba8  /bin/sh -c #(nop) MAINTAINER Learning Docker      0 B
431dac4e3917  /bin/sh -c #(nop) CMD [/bin/bash]                 0 B
a70fb0647e6e  /bin/sh -c #(nop) ADD file:29e52cbeed164d50b3
              in /                                              90.08 MB
511136ea3c5a                                                    0 B
</code></pre></li>
<li><p>Run <code>docker build</code> on the same Dockerfile again.  This time <code>docker build</code> was able to take advantage of its image cache and complete the build in just a little bit over one second.</p>

<pre><code>Sending build context to Docker daemon   6.3 MB
Sending build context to Docker daemon 
Step 0 : FROM debian:jessie
 ---&gt; 431dac4e3917
Step 1 : MAINTAINER Learning Docker &lt;jimmy.huang@learningdocker.com&gt;
 ---&gt; Using cache
 ---&gt; bf6e66ab7ba8
Step 2 : RUN apt-get update &amp;&amp; apt-get install -qy  curl  git  libpq-dev  libprocps3  libprocps3-dev  nodejs  postgresql  procps
 ---&gt; Using cache
 ---&gt; 414985d91f17
Step 3 : RUN curl -sSL https://get.rvm.io | bash -s stable
 ---&gt; Using cache
 ---&gt; f6c04b16f9a3
Step 4 : RUN ["/bin/bash", "-l", "-c", "rvm requirements; rvm install 2.1.2; gem install bundler --no-ri --no-rdoc"]
 ---&gt; Using cache
 ---&gt; 20530f4640b2
Step 5 : COPY Gemfile /app/Gemfile
 ---&gt; Using cache
 ---&gt; b4a579d1f1f3
Step 6 : COPY Gemfile.lock /app/Gemfile.lock
 ---&gt; Using cache
 ---&gt; 0ee1481ca560
Step 7 : WORKDIR /app
 ---&gt; Using cache
 ---&gt; 2d37b923faf9
Step 8 : RUN ["/bin/bash", "-l", "-c", "bundle install"]
 ---&gt; Using cache
 ---&gt; 1c18d721dd22
Step 9 : ADD . /app
 ---&gt; Using cache
 ---&gt; 84224a27c2f0
Step 10 : EXPOSE 3000
 ---&gt; Using cache
 ---&gt; be55e982050d
Step 11 : CMD ["/app/bin/start-server"]
 ---&gt; Using cache
 ---&gt; 25eaf04c070f
Successfully built 25eaf04c070f

real    0m0.648s
user    0m0.015s
sys 0m0.024s
</code></pre></li>
<li><p>Push the newly created Docker image to your Docker Hub account.</p>

<pre><code>Host% docker push $DOCKERUSER/docker_quick_start
</code></pre></li>
</ol>


<h3>How Docker Image Caching Works</h3>

<p>Docker starts the image building process by first launching a container from the base image.  Each instruction in Dockerfile makes a change to the container's filesystem.  Docker commits that change as a new image and then launches another container from the new image.</p>

<p>As Docker steps through a given Dockerfile, it will use the image generated by the previous instruction (parent image) and the current instruction to do the cache lookup.  Docker will iterate over all the images that depend on the parent image and look for one with the same instruction applied to it as the current instruction.  If a match surfaces, Docker will skip to the next instruction in the Dockerfile; if no match is found, Docker will execute the current instruction on a container launched from the parent image and commit the resulting change as a new image.  The process repeats until all the instructions in the Dockerfile have been evaluated.</p>
